# Font Format Conversion Matrix
#
# This file defines the supported font format conversions for Fontisan.
# Each conversion specifies a source format ('from') and target format ('to').
#
# Format identifiers:
# - ttf: TrueType Font (with glyf/loca tables)
# - otf: OpenType Font with CFF outlines (with CFF table)
# - woff: Web Open Font Format (not yet implemented)
# - woff2: Web Open Font Format 2 (implemented in Phase 2)
# - svg: SVG Font (implemented in Phase 2)
#
# Phase 1 (Milestone 1.3): Basic conversions
# - Same format (copy/optimize): ttf→ttf, otf→otf
# - Outline conversion: ttf↔otf (foundation implemented)
#
# Phase 2 (Milestone 2.1): Web font formats
# - WOFF2 compression: ttf to woff2, otf to woff2
#
# Phase 2 (Milestone 2.2): SVG font generation
# - SVG export: ttf to svg, otf to svg
#
# Future phases:
# - Phase 3: Variable font conversions

conversions:
  # Same-format conversions (copy/optimize)
  - from: ttf
    to: ttf
    strategy: table_copier
    description: "Copy TrueType font with table optimization"
    status: implemented

  - from: otf
    to: otf
    strategy: table_copier
    description: "Copy OpenType/CFF font with table optimization"
    status: implemented

  # Outline format conversions
  - from: ttf
    to: otf
    strategy: outline_converter
    description: "Convert TrueType outlines to CFF format"
    status: foundation
    notes: >
      Foundation implemented. Full conversion requires complete CFF table
      generation including CharString encoding, DICT structures, and
      charset/encoding tables.

  - from: otf
    to: ttf
    strategy: outline_converter
    description: "Convert CFF outlines to TrueType format"
    status: foundation
    notes: >
      Foundation implemented. Full conversion requires complete glyf/loca
      table generation including cubic-to-quadratic curve conversion and
      proper TrueType glyph structure encoding.

  # Phase 2 conversions (Milestone 2.1) - WOFF2
  - from: ttf
    to: woff2
    strategy: woff2_encoder
    description: "Compress TrueType to WOFF2 format with Brotli"
    status: implemented
    notes: >
      WOFF2 encoding with Brotli compression. Table transformations
      are architectural placeholders for future optimization.

  - from: otf
    to: woff2
    strategy: woff2_encoder
    description: "Compress OpenType/CFF to WOFF2 format with Brotli"
    status: implemented
    notes: >
      WOFF2 encoding with Brotli compression. Table transformations
      are architectural placeholders for future optimization.

  # Phase 2 conversions (Milestone 2.3) - WOFF
  - from: ttf
    to: woff
    strategy: woff_writer
    description: "Compress TrueType to WOFF format with zlib"
    status: implemented
    notes: >
      WOFF 1.0 encoding with zlib compression. Supports optional metadata
      and private data blocks. Individual table compression for optimal
      file size reduction.

  - from: otf
    to: woff
    strategy: woff_writer
    description: "Compress OpenType/CFF to WOFF format with zlib"
    status: implemented
    notes: >
      WOFF 1.0 encoding with zlib compression. Supports optional metadata
      and private data blocks. Individual table compression for optimal
      file size reduction.

  - from: woff
    to: woff
    strategy: woff_recompress
    description: "Copy WOFF font with re-compression"
    status: implemented
    notes: >
      Same-format copy operation. Decompresses and re-compresses WOFF data,
      useful for normalizing compression or updating metadata.

  # Reverse WOFF conversions (WOFF → TTF/OTF)
  - from: woff
    to: ttf
    strategy: woff_reader
    description: "Extract TrueType from WOFF format"
    status: implemented
    notes: >
      WOFF decompression with zlib. Preserves all font data and metadata.
      Automatically detects font flavor from WOFF header.

  - from: woff
    to: otf
    strategy: woff_reader
    description: "Extract OpenType/CFF from WOFF format"
    status: implemented
    notes: >
      WOFF decompression with zlib. Preserves all font data and metadata.
      Automatically detects font flavor from WOFF header.

  # Phase 2 conversions (Milestone 2.2) - SVG
  - from: ttf
    to: svg
    strategy: svg_generator
    description: "Generate SVG font from TrueType"
    status: implemented
    notes: >
      SVG font generation with full glyph outline extraction and coordinate
      transformation. Note: SVG fonts are deprecated in favor of WOFF2, but
      useful for fallback, conversion, and inspection purposes.

  - from: otf
    to: svg
    strategy: svg_generator
    description: "Generate SVG font from OpenType/CFF"
    status: implemented
    notes: >
      SVG font generation with full glyph outline extraction and coordinate
      transformation. Note: SVG fonts are deprecated in favor of WOFF2, but
      useful for fallback, conversion, and inspection purposes.

  # WOFF2 decompression (reverse conversions)
  - from: woff2
    to: ttf
    strategy: woff2_decoder
    description: "Decompress WOFF2 to TrueType format"
    status: implemented
    notes: >
      WOFF2 decompression with Brotli. Reverses table transformations
      (glyf/loca, hmtx) if present. Preserves all font data and metadata.
      Automatically detects font flavor from WOFF2 header.

  - from: woff2
    to: otf
    strategy: woff2_decoder
    description: "Decompress WOFF2 to OpenType/CFF format"
    status: implemented
    notes: >
      WOFF2 decompression with Brotli. Reverses table transformations
      if present. Preserves all font data and metadata. Automatically
      detects font flavor from WOFF2 header.

  - from: woff2
    to: woff2
    strategy: woff2_recompress
    description: "Copy WOFF2 font with re-compression"
    status: implemented
    notes: >
      Same-format copy operation. Decompresses and re-compresses WOFF2 data
      with Brotli, useful for normalizing compression or updating metadata.

  # Collection format conversions (TTC/OTC/dfont)
  # Same-format collection operations
  - from: ttc
    to: ttc
    strategy: collection_copier
    description: "Copy TrueType Collection"
    status: implemented
    notes: >
      Same-format copy operation for TTC files. Preserves all fonts and
      table sharing structure.

  - from: otc
    to: otc
    strategy: collection_copier
    description: "Copy OpenType Collection"
    status: implemented
    notes: >
      Same-format copy operation for OTC files. Preserves all fonts and
      table sharing structure.

  - from: dfont
    to: dfont
    strategy: collection_copier
    description: "Copy Apple dfont suitcase"
    status: implemented
    notes: >
      Same-format copy operation for dfont files. Preserves all fonts in
      the suitcase.

  # Cross-collection conversions
  - from: ttc
    to: otc
    strategy: collection_converter
    description: "Convert TrueType Collection to OpenType Collection"
    status: implemented
    notes: >
      Unpacks TTC, converts all TrueType fonts to OpenType/CFF format,
      then repacks as OTC with table sharing optimization.

  - from: otc
    to: ttc
    strategy: collection_converter
    description: "Convert OpenType Collection to TrueType Collection"
    status: implemented
    notes: >
      Unpacks OTC, converts all OpenType/CFF fonts to TrueType format,
      then repacks as TTC with table sharing optimization.

  - from: ttc
    to: dfont
    strategy: collection_converter
    description: "Convert TrueType Collection to dfont suitcase"
    status: implemented
    notes: >
      Unpacks TTC and repacks as Apple dfont suitcase. No outline conversion
      needed as dfont supports TrueType fonts.

  - from: otc
    to: dfont
    strategy: collection_converter
    description: "Convert OpenType Collection to dfont suitcase"
    status: implemented
    notes: >
      Unpacks OTC and repacks as Apple dfont suitcase. No outline conversion
      needed as dfont supports OpenType/CFF fonts.

  - from: dfont
    to: ttc
    strategy: collection_converter
    description: "Convert dfont suitcase to TrueType Collection"
    status: implemented
    notes: >
      Unpacks dfont suitcase and repacks as TTC. If dfont contains OpenType
      fonts, they are converted to TrueType format. Only valid if all fonts
      can be converted to TrueType.

  - from: dfont
    to: otc
    strategy: collection_converter
    description: "Convert dfont suitcase to OpenType Collection"
    status: implemented
    notes: >
      Unpacks dfont suitcase and repacks as OTC. If dfont contains TrueType
      fonts, they are converted to OpenType/CFF format.

# Conversion compatibility matrix
#
# This section documents which source features are preserved in conversions.
# Not all features can be preserved across format boundaries.
#
compatibility:
  ttf_to_otf:
    preserves:
      - glyph_outlines
      - font_metrics
      - name_table
      - layout_features
      - kerning
    limitations:
      - quadratic_to_cubic_approximation: >
          TrueType quadratic curves are converted to CFF cubic curves.
          The conversion is mathematically exact.
      - hinting_loss: >
          TrueType hinting instructions are not converted to CFF hints.

  otf_to_ttf:
    preserves:
      - glyph_outlines
      - font_metrics
      - name_table
      - layout_features
      - kerning
    limitations:
      - cubic_to_quadratic_approximation: >
          CFF cubic curves must be approximated as TrueType quadratic curves.
          Multiple quadratic curves may be needed for accuracy.
      - hinting_loss: >
          CFF hints are not converted to TrueType hinting instructions.

  same_format:
    preserves:
      - all_tables
      - all_features
      - exact_outline_data
    benefits:
      - table_reordering: Tables are written in optimal order
      - checksum_correction: All checksums are recalculated
      - padding_normalization: Table padding is normalized

  to_woff2:
    preserves:
      - glyph_outlines
      - font_metrics
      - all_tables
      - layout_features
    benefits:
      - brotli_compression: Excellent compression ratio for web delivery
      - smaller_file_size: Typically 30-50% smaller than TTF/OTF
    limitations:
      - web_only: Primarily for web font delivery
      - browser_support: Not all browsers support WOFF2

  to_svg:
    preserves:
      - glyph_outlines: Outlines converted to SVG paths
      - font_metrics: Basic metrics in font-face element
      - unicode_mappings: Unicode to glyph associations
    limitations:
      - deprecated_format: SVG fonts deprecated in favor of WOFF2
      - limited_browser_support: Mainly Safari
      - no_hinting: Hinting information not preserved
      - no_advanced_features: Complex layout features not supported
    use_cases:
      - fallback: Emergency fallback for very old browsers
      - conversion: Intermediate format for font conversion workflows
      - inspection: Easy-to-read format for font inspection

  collection_conversions:
    ttc_to_otc:
      preserves:
        - all_fonts: All fonts in collection
        - font_metrics: Font metrics for each font
        - layout_features: Layout features for each font
      limitations:
        - outline_conversion_required: TrueType to CFF conversion applied
        - hinting_loss: TrueType hinting not preserved in CFF
      notes: >
        Converts all TrueType fonts to OpenType/CFF format using the standard
        TTF→OTF conversion pipeline, then repacks with table sharing.

    otc_to_ttc:
      preserves:
        - all_fonts: All fonts in collection
        - font_metrics: Font metrics for each font
        - layout_features: Layout features for each font
      limitations:
        - outline_conversion_required: CFF to TrueType conversion applied
        - hinting_loss: CFF hints not preserved in TrueType
        - approximation: Cubic to quadratic curve approximation
      notes: >
        Converts all OpenType/CFF fonts to TrueType format using the standard
        OTF→TTF conversion pipeline, then repacks with table sharing.

    to_dfont:
      preserves:
        - all_fonts: All fonts in collection
        - original_formats: Preserves original outline formats (TTF or OTF)
        - font_metrics: All font metrics
        - layout_features: All layout features
      benefits:
        - mixed_formats: dfont supports both TrueType and OpenType fonts
        - mac_compatibility: Native Mac OS X suitcase format
      limitations:
        - platform_specific: Mac OS X only, not cross-platform
        - no_table_sharing: dfont doesn't deduplicate tables like TTC/OTC
      notes: >
        Repackages fonts into Apple dfont suitcase format. No outline conversion
        needed as dfont supports any SFNT font type (TTF, OTF, or mixed).

    from_dfont:
      preserves:
        - all_fonts: All fonts in suitcase
        - font_metrics: All font metrics
        - layout_features: All layout features
      limitations:
        - conversion_may_be_required: Outline conversion if target requires specific format
        - hinting_loss: If outline conversion occurs
      benefits:
        - cross_platform: TTC/OTC work on all platforms
        - table_sharing: TTC/OTC optimize with table deduplication
      notes: >
        Extracts fonts from dfont suitcase and repacks into TTC or OTC.
        Outline conversion may occur depending on target format requirements.

# Collection format rules
collection_rules:
  ttc:
    required_format: truetype
    allows_mixed: false
    spec_compliance: opentype_spec
    description: >
      TrueType Collection per OpenType specification. Contains only TrueType
      fonts (glyf/loca tables). CFF fonts are not allowed.

  otc:
    required_format: cff_preferred
    allows_mixed: true
    spec_compliance: opentype_1.8
    description: >
      OpenType Collection per OpenType 1.8 specification. Requires at least
      one CFF font. Fontisan extension allows mixed TTF+OTF for flexibility.

  dfont:
    required_format: any_sfnt
    allows_mixed: true
    spec_compliance: apple_proprietary
    description: >
      Apple dfont (Data Fork Font) suitcase. Contains Mac font suitcase
      resources (FOND, NFNT, sfnt). Supports any SFNT fonts (TrueType,
      OpenType/CFF, or mixed). Mac OS X specific, not cross-platform.

  prohibited:
    - web_fonts_in_collections: >
        WOFF and WOFF2 fonts cannot be included in collections (TTC, OTC, or dfont).
        Web fonts are designed for single-font web delivery only.